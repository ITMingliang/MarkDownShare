# 模型绑定和验证

## 一、模型绑定获取表单数据

模型绑定即将浏览器发送的HTTP请求数据转换为.NET对象的过程。

模型绑定使我们在控制器中可以直接获取视图，或URL传递过来的数据，并且这些数据可以自动转换为模型对象，以便调用。

**以下是新增员工表单提交的例子：**

表单页面Action:

```
public ActionResult Demo01()
{
	return View();
}
```

表单视图：

```
<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo01</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }

        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }

            .myTable td {
                height: 30px;
                line-height: 30px;
                padding: 6px;
            }
    </style>
    <script src="~/Js/jquery-1.10.2.js"></script>
    <script type="text/javascript">
        $(function () {
            $("#btAdd").click(function () {
                var strCheck = "";
                $("input:checkbox[name=ckHobby]:checked").each(function () {
                    if (strCheck != "")
                        strCheck += ",";
                    strCheck += $(this).val();
                })
                $("#Hobby").val(strCheck);
            })
        })
    </script>
</head>
<body>
    <form method="post" action="~/Home/Demo01Show">
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">员工新增</td>
                </tr>
                <tr>
                    <td width="200" align="right">所属部门：</td>
                    <td width="600" align="left">
                        <select name="DeptName" id="DeptName">
                            <option value="请选择">--请选择--</option>
                            <option value="总经办">总经办</option>
                            <option value="行政部">行政部</option>
                            <option value="市场部">市场部</option>
                            <option value="技术部">技术部</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">员工姓名：</td>
                    <td width="600" align="left"><input type="text" name="RealName" /></td>
                </tr>
                <tr>
                    <td width="200" align="right">员工电话：</td>
                    <td width="600" align="left"><input type="text" name="Phone" /></td>
                </tr>
                <tr>
                    <td width="200" align="right">性别：</td>
                    <td width="600" align="left">
                    <input type="radio" name="Sex" id="boy" value="男" />男
                    <input type="radio" name="Sex" id="girl" value="女" />女
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">爱好：</td>
                    <td width="600" align="left">
                        <input type="checkbox" name="ckHobby" value="抽烟" />抽烟
                        <input type="checkbox" name="ckHobby" value="喝酒" />喝酒
                        <input type="checkbox" name="ckHobby" value="烫头发" />烫头发
                        <input type="checkbox" name="ckHobby" value="打游戏" />打游戏
                        <input type="hidden" name="Hobby" id="Hobby" value="" />
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input id="btAdd" type="submit" value="新增员工" />
                    </td>
                </tr>
            </table>
        </div>
    </form>

</body>
</html>
```

模型对象：

```
public class Employee
{

    public int EmpId { get; set; }
    public string DeptName { get; set; }
    public string RealName { get; set; }
    public string Phone { get; set; }
    public string Sex { get; set; }
    public string Hobby { get; set; }
}
```

接受数据的Action:

```
public ActionResult Demo01Show(Employee emp)
{
    //可以使用Request对象来接受
    //string str = "员工基本信息如下:";
    //str += "<div>员工姓名:" + Request["RealName"] + "</div>";
    //str += "<div>所属部门:" + Request["DeptName"] + " </div>";
    //str += "<div>员工电话:" + Request["Phone"] + " </div>";
    //str += "<div>员工性别:" + Request["Sex"] + " </div>";
    //str += "<div>员工爱好:" + Request["Hobby"] + " </div>";
    //可以直接通过模型绑定表单数据（表单元素名必须和对象属性名相同，并且只支持Post请求）
    string str = "员工基本信息如下:";
    str += "<div>员工姓名:" + emp.RealName + "</div>";
    str += "<div>所属部门:" + emp.DeptName + "</div>";
    str += "<div>员工电话:" + emp.Phone + "</div>";
    str += "<div>员工性别:" + emp.Sex + "</div>";
    str += "<div>员工爱好:" + emp.Hobby + "</div>";
    ViewBag.Info = str;
    return View();
}
```

显示数据的视图：

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo01Show</title>
    <style type="text/css">
        #container div {
            height:30px; line-height:30px;
        }
    </style>
</head>
<body>
    <div id="container">
        @Html.Raw(ViewBag.Info) 
    </div>
</body>
</html>
```

模型绑定需要遵守相关约定。在视图中，表单标签的name属性和模型对象属性的名称必须相同，否则无法完成绑定。

## 二、基本类型绑定获取数据

获取表单提交的姓名和分数，在本页面底部直接显示提交的数据。

Action:

```
public ActionResult Demo02(string RealName,int? Score)
{
    if(RealName != null && !RealName.Equals(""))
    {
        string str = "表单提交信息如下:";
        str += "<div>姓名:" + RealName + "</div>";
        str += "<div>分数:" + Score + "</div>";
        ViewBag.Info = str;
    }
    return View();
}
```

View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo02</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }

        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }

            .myTable td {
                height: 30px;
                line-height: 30px;
                padding: 6px;
            }
        #container div {
            height:30px; line-height:30px;
        }
    </style>

</head>
<body>
    <form method="post" action="~/Home/Demo02">
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">分数录入</td>
                </tr>
                <tr>
                    <td width="200" align="right">姓名：</td>
                    <td width="600" align="left"><input type="text" name="RealName" /></td>
                </tr>
                <tr>
                    <td width="200" align="right">分数：</td>
                    <td width="600" align="left"><input type="text" name="Score" /></td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input id="btAdd" type="submit" value="提交信息" />
                    </td>
                </tr>
            </table>
        </div>
    </form>
    <div id="container">
        @Html.Raw(ViewBag.Info)
    </div>
</body>
</html>
```

## 三、上传文件

资料（用于根据文件内容判断文件格式的函数）：

```
public bool IsAllowedExtensionKG(HttpPostedFileBase postFile, FileExtension[] fileEx)
{
    int fileLen = postFile.ContentLength;
    byte[] imgArray = new byte[fileLen];
    postFile.InputStream.Read(imgArray, 0, fileLen);
    string fileclass = imgArray[0].ToString() + imgArray[1].ToString();
    foreach (FileExtension fe in fileEx)
    {
        if (Int32.Parse(fileclass) == (int)fe)
            return true;
    }
    return false;
}
public enum FileExtension
{
    JPG = 255216,
    GIF = 7173,
    BMP = 6677,
    PNG = 13780,
    RAR = 8297,
    jpg = 255216,
    exe = 7790,
    xml = 6063,
    html = 6033,
    aspx = 239187,
    cs = 117115,
    js = 119105,
    txt = 210187,
    sql = 255254
}
```

### （1）文件上传基本功能

页面Action:

```
public ActionResult Demo03()
{
    //需要设置form enctype="multipart/form-data"才能正常提交文件
    return View();
}
```

View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo03</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }

        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }

            .myTable td {
                height: 30px;
                line-height: 30px;
                padding: 6px;
            }
    </style>
</head>
<body>
    <form method="post" action="~/Home/Demo03Save" enctype="multipart/form-data">
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">图片上传</td>
                </tr>
                <tr>
                    <td width="200" align="right">请选择图片：</td>
                    <td width="600" align="left"><input type="file" name="fileImg" /></td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input type="submit" value="上传" />
                        <a href="~/UploadFile/@TempData["FileName"]" target="_blank">@TempData["FileName"]</a>
                    </td>
                </tr>
            </table>
        </div>
    </form>
</body>
</html>
```

文件上传处理的Action:

```
public ActionResult Demo03Save()
{
    HttpPostedFileBase postFile = Request.Files["fileImg"];           
    if (postFile == null || postFile.ContentLength == 0)
        return Content("<script>alert('您上传的是空文件!');window.location.href='Demo03';</script >", "text/html");
    if (postFile.ContentLength > 1024 * 1024)
        return Content("<script>alert('文件过大,不能超过1M!');window.location.href='Demo03';</script >", "text/html");
    string[] ArrayFileLastName = postFile.FileName.Split('.');
    if(ArrayFileLastName.Length < 2)
        return Content("<script>alert('文件格式错误,没有文件后缀名!');window.location.href='Demo03';</script >", "text/html");
    //根据文件名判断文件格式是否是"jpg","jpeg","gif","png"
    string lastName = ArrayFileLastName[ArrayFileLastName.Length - 1].ToLower();
    string[] ArrayNames = new string[] { "jpg", "jpeg", "gif", "png" };
    if(!ArrayNames.Contains(lastName))
        return Content("<script>alert('文件格式错误,只支持jpg,jpeg,gif,png!');window.location.href='Demo03';</script >", "text/html");
    //根据文件内容判断文件格式是否是"jpg","jpeg","gif","png"
    FileExtension[] fe = { FileExtension.GIF, FileExtension.JPG, FileExtension.PNG };
    if (IsAllowedExtensionKG(postFile, fe) == false)
        return Content("<script>alert('文件格式错误,只支持jpg,jpeg,gif,png!');window.location.href='Demo03';</script >", "text/html");
    string myFileName = System.Guid.NewGuid().ToString() + "." + lastName;
    postFile.SaveAs(Server.MapPath("~/UploadFile/")+myFileName);
    TempData["FileName"] = myFileName;
    return RedirectToAction("Demo03");
}
```

其中的文件获取可以使用Request接受，也可以直接使用Action函数的参数来接受，如下：

```
public ActionResult Demo03Save(HttpPostedFileBase fileImg)
{
	......
}
```

### （2）结合其他表单标签

Action代码：

```
public ActionResult Demo04()
{
    return View();
}
public ActionResult Demo04Show()
{
    HttpPostedFileBase myFile = Request.Files["photo"];

    if (myFile == null || myFile.ContentLength == 0)
        return Content("<script>alert('请选择文件!');window.location.href='Demo04';</script>");
    if(myFile.ContentLength == 1024*1024*3)
        return Content("<script>alert('文件大小不能超过3M!');window.location.href='Demo04';</script>");

    string[] arr = myFile.FileName.Split('.');
    string fileFix = arr[arr.Length-1];

    string[] arrFix = new string[] { "jpg","gif","png"};
    if(!arrFix.Contains(fileFix.ToLower()))
        return Content("<script>alert('文件类型不正确!');window.location.href='Demo04';</script>");
    FileExtension[] arrExtension = new FileExtension[] { FileExtension.JPG, FileExtension.jpg, FileExtension.GIF, FileExtension.PNG };
    if (IsAllowedExtensionKG(myFile, arrExtension) == false)
        return Content("<script>alert('文件类型不正确!');window.location.href='Demo04';</script>");

    string newFileName = Guid.NewGuid() + "." + fileFix;
    string uploadPath = Server.MapPath("~/upload/"+ newFileName);

    myFile.SaveAs(uploadPath);

    ViewBag.Acc = Request["Acc"];
    ViewBag.Pwd = Request["Pwd"];
    ViewBag.photo = newFileName;
    ViewBag.Phone = Request["Phone"];
    return View();
}
```

表单View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo04</title>
</head>
<body>
    <form action="Demo04Show" method="post" enctype="multipart/form-data">
        <p>
            用户名：<input type="text" name="Acc" />
        </p>
        <p>
            密码：<input type="password" name="Pwd" />
        </p>
        <p>
            请选择图片: <input type="file" name="photo" />
        </p>
        <p>
            电话：<input type="text" name="Phone" />
        </p>
        <p>
            <input type="submit" value="提交" />
            <a href="~/upload/@TempData["newFileName"]" target="_blank">@TempData["newFileName"]</a>
        </p>
    </form>
</body>
</html>
```

信息显示View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo04Show</title>
</head>
<body>
    <div> 
        <h2>用户名：@ViewBag.Acc</h2>
        <h2>密码：@ViewBag.Pwd</h2>
        <h2>图片：<br />
        <img src="~/upload/@ViewBag.photo" />
        </h2>
        <h2>电话：@ViewBag.Phone</h2>
    </div>
</body>
</html>
```

### （3）Iframe实现上传

Action代码：

```
public ActionResult Demo05()
{
    return View();
}
public ActionResult Demo05SaveImg()
{
    HttpPostedFileBase postFile = Request.Files["fileImg"];
    if (postFile == null || postFile.ContentLength == 0)
        return Content("<script>window.parent.ErrorUploadImg('您上传的是空文件!');</script >", "text/html");
    if (postFile.ContentLength > 1024 * 1024)
        return Content("<script>window.parent.ErrorUploadImg('文件过大,不能超过1M!');</script >", "text/html");
    string[] ArrayFileLastName = postFile.FileName.Split('.');
    if (ArrayFileLastName.Length < 2)
        return Content("<script>window.parent.ErrorUploadImg('文件格式错误,没有文件后缀名!');</script >", "text/html");
    //根据文件名判断文件格式是否是"jpg","jpeg","gif","png"
    string lastName = ArrayFileLastName[ArrayFileLastName.Length - 1].ToLower();
    string[] ArrayNames = new string[] { "jpg", "jpeg", "gif", "png" };
    if (!ArrayNames.Contains(lastName))
        return Content("<script>window.parent.ErrorUploadImg('文件格式错误,只支持jpg,jpeg,gif,png!');</script >", "text/html");
    //根据文件内容判断文件格式是否是"jpg","jpeg","gif","png"
    FileExtension[] fe = { FileExtension.GIF, FileExtension.JPG, FileExtension.PNG };
    if (IsAllowedExtensionKG(postFile, fe) == false)
        return Content("<script>window.parent.ErrorUploadImg('文件格式错误,只支持jpg,jpeg,gif,png!');</script >", "text/html");
    string myFileName = System.Guid.NewGuid().ToString() + "." + lastName;
    try
    {
        postFile.SaveAs(Server.MapPath("~/UploadFile/") + myFileName);
        return Content("<script>window.parent.ShowUploadImg('"+ myFileName + "');</script >", "text/html");
    }
    catch (Exception ex)
    {
        return Content("<script>window.parent.ErrorUploadImg('"+ex.Message+"');</script >", "text/html");
    }    
}
public ActionResult Demo05Show()
{
    string str = "员工基本信息如下:";
    str += "<div>员工姓名:" + Request["RealName"] + "</div>";
    str += "<div style='height:auto;'>员工头像:<img src='/UploadFile/"+ Request["hdImg"] + "' /> </div>";
    str += "<div>所属部门:" + Request["DeptName"] + " </div>";
    str += "<div>员工电话:" + Request["Phone"] + " </div>";
    str += "<div>员工性别:" + Request["Sex"] + " </div>";
    str += "<div>员工爱好:" + Request["Hobby"] + " </div>";
    ViewBag.Info = str;
    return View();
}
```

表单页面View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo05</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }
        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }
        .myTable td {
            height: 30px;
            line-height: 30px;
            padding: 6px;
        }
    </style>
    <script src="~/Js/jquery-1.10.2.js"></script>
    <script type="text/javascript">
        $(function () {
            $("#btUpload").click(function () {
                if ($("#fileImg").val().length == 0) {
                    $("#spanImgInfo").text("请选择文件!");
                    return;
                }
                if ($("#fileImg")[0].files[0].size > 1024 * 1024) {
                    $("#spanImgInfo").text("房屋结构图文件太大,最大不能超过1M!");
                    return;
                }
                $("#spanImgInfo").text("文件上传中...");
                $("#frm1").attr("target", "frameFile");
                $("#frm1").attr("action", "Demo05SaveImg");
                $("#frm1").submit();
            })
            
            $("#btAdd").click(function () {
                var strCheck = "";
                $("input:checkbox[name=ckHobby]:checked").each(function () {
                    if (strCheck != "")
                        strCheck += ",";
                    strCheck += $(this).val();
                })
                $("#Hobby").val(strCheck);
                
                $("#frm1").attr("target", "_self");
                $("#frm1").attr("action", "Demo05Show");
                $("#frm1").submit();
            })
        })

        function ShowUploadImg(fileName) {
            $("#hdImg").val(fileName);
            $("#spanImgInfo").html("<a href='/UploadFile/" + fileName + "' target='_blank'>" + fileName + "</a>");
        }
        function ErrorUploadImg(errInfo) {
            $("#spanImgInfo").html(errInfo);
        }       
    </script>
</head>
<body>
    <form method="post" action="~/Home/Demo05Show" id="frm1" enctype="multipart/form-data">
        <iframe id="frameFile" name="frameFile" style="display: none;"></iframe>
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">员工新增</td>
                </tr>
                <tr>
                    <td width="200" align="right">所属部门：</td>
                    <td width="600" align="left">
                        <select name="DeptName" id="DeptName">
                            <option value="请选择">--请选择--</option>
                            <option value="总经办">总经办</option>
                            <option value="行政部">行政部</option>
                            <option value="市场部">市场部</option>
                            <option value="技术部">技术部</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">员工姓名：</td>
                    <td width="600" align="left"><input type="text" name="RealName" /></td>
                </tr>
                <tr>
                    <td width="200" align="right">头像：</td>
                    <td width="600" align="left">
                        <input type="file" name="fileImg" id="fileImg" />
                        <input id="btUpload" type="button" value="上传" />
                        <br />
                        <span id="spanImgInfo"></span>
                        <input type="hidden" name="hdImg" id="hdImg" />
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">员工电话：</td>
                    <td width="600" align="left"><input type="text" name="Phone" /></td>
                </tr>
                <tr>
                    <td width="200" align="right">性别：</td>
                    <td width="600" align="left">
                        <input type="radio" name="Sex" id="boy" value="男" />男
                        <input type="radio" name="Sex" id="girl" value="女" />女
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">爱好：</td>
                    <td width="600" align="left">
                        <input type="checkbox" name="ckHobby" value="抽烟" />抽烟
                        <input type="checkbox" name="ckHobby" value="喝酒" />喝酒
                        <input type="checkbox" name="ckHobby" value="烫头发" />烫头发
                        <input type="checkbox" name="ckHobby" value="打游戏" />打游戏
                        <input type="hidden" name="Hobby" id="Hobby" value="" />
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input id="btAdd" type="submit" value="新增员工" />
                    </td>
                </tr>
            </table>
        </div>
    </form>
</body>
</html>
```

员工信息显示View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo05Show</title>
    <style type="text/css">
        #container div {
            height: 30px;
            line-height: 30px;
        }
    </style>
</head>
<body>
    <div id="container"> 
        @Html.Raw(ViewBag.Info) 
    </div>
</body>
</html>
```

### （4）Iframe多文件上传

Action代码：

```
public ActionResult Demo06()
{
    return View();
}
public ActionResult Demo06SaveImg()
{
    HttpPostedFileBase postFile = Request.Files["fileImg"];
    if (postFile == null || postFile.ContentLength == 0)
        return Content("<script>window.parent.ErrorUploadImg('您上传的是空文件!');</script >", "text/html");
    if (postFile.ContentLength > 1024 * 1024)
        return Content("<script>window.parent.ErrorUploadImg('文件过大,不能超过1M!');</script >", "text/html");
    string[] ArrayFileLastName = postFile.FileName.Split('.');
    if (ArrayFileLastName.Length < 2)
        return Content("<script>window.parent.ErrorUploadImg('文件格式错误,没有文件后缀名!');</script >", "text/html");
    //根据文件名判断文件格式是否是"jpg","jpeg","gif","png"
    string lastName = ArrayFileLastName[ArrayFileLastName.Length - 1].ToLower();
    string[] ArrayNames = new string[] { "jpg", "jpeg", "gif", "png" };
    if (!ArrayNames.Contains(lastName))
        return Content("<script>window.parent.ErrorUploadImg('文件格式错误,只支持jpg,jpeg,gif,png!');</script >", "text/html");
    //根据文件内容判断文件格式是否是"jpg","jpeg","gif","png"
    FileExtension[] fe = { FileExtension.GIF, FileExtension.JPG, FileExtension.PNG };
    if (IsAllowedExtensionKG(postFile, fe) == false)
        return Content("<script>window.parent.ErrorUploadImg('文件格式错误,只支持jpg,jpeg,gif,png!');</script >", "text/html");
    string myFileName = System.Guid.NewGuid().ToString() + "." + lastName;
    try
    {
        postFile.SaveAs(Server.MapPath("~/UploadFile/") + myFileName);
        return Content("<script>window.parent.ShowUploadImg('" + myFileName + "');</script >", "text/html");
    }
    catch (Exception ex)
    {
        return Content("<script>window.parent.ErrorUploadImg('" + ex.Message + "');</script >", "text/html");
    }
}
public ActionResult Demo06Show()
{
    string str = "员工基本信息如下:";
    str += "<div>员工姓名:" + Request["RealName"] + "</div>";
    str += "<div style='height:auto;'>员工头像: ";
    string[] arr = Request["hdImg"].Split(',');
    foreach (string item in arr)
    {
        str += "<img width='120' height='120' src='/UploadFile/" + item + "' />";
    }
    str += "</div>";
    str += "<div>所属部门:" + Request["DeptName"] + " </div>";
    str += "<div>员工电话:" + Request["Phone"] + " </div>";
    str += "<div>员工性别:" + Request["Sex"] + " </div>";
    str += "<div>员工爱好:" + Request["Hobby"] + " </div>";
    ViewBag.Info = str;
    return View();
}
```

表单View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo06</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }

        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }

            .myTable td {
                height: 30px;
                line-height: 30px;
                padding: 6px;
            }
        #spanImgInfo div { width:120px; height:130px; line-height:30px; float:left;
                           text-align:center;
        }
    </style>
    <script src="~/Js/jquery-1.10.2.js"></script>
    <script type="text/javascript">
        $(function () {
            $("#btUpload").click(function () {
                $("#spanErr").html("");
                if ($("#fileImg").val().length == 0) {
                    $("#spanErr").text("请选择文件!");
                    return;
                }
                if ($("#fileImg")[0].files[0].size > 1024 * 1024) {
                    $("#spanErr").text("房屋结构图文件太大,最大不能超过1M!");
                    return;
                }
                $("#spanErr").text("文件上传中...");
                $("#frm1").attr("target", "frameFile");
                $("#frm1").attr("action", "Demo06SaveImg");
                $("#frm1").submit();
            })

            $("#btAdd").click(function () {
                var strCheck = "";
                $("input:checkbox[name=ckHobby]:checked").each(function () {
                    if (strCheck != "")
                        strCheck += ",";
                    strCheck += $(this).val();
                })
                $("#Hobby").val(strCheck);

                $("#frm1").attr("target", "_self");
                $("#frm1").attr("action", "Demo06Show");
                $("#frm1").submit();
            })

            //删除图片
            $("#spanImgInfo").on("click", ".del", function () {           
                //删除存放图片名隐藏域中的字符串
                var arrFileName = $("#hdImg").val().split(',');
                if (arrFileName.length <= 1)
                    $("#hdImg").val("");
                else if(arrFileName[0] == $(this).prop("title"))
                    $("#hdImg").val($("#hdImg").val().replace($(this).prop("title") + ",", ""));
                else
                    $("#hdImg").val($("#hdImg").val().replace("," + $(this).prop("title") , ""));
                //删除图片显示
                $(this).parent().remove();
            })

        })

        function ShowUploadImg(fileName) {

            //判断存放图片名称的隐藏域中是否有内容,没有内容直接添加文件名，有内容逗号+文件名
            if ($("#hdImg").val() == "")
                $("#hdImg").val(fileName);
            else
                $("#hdImg").val($("#hdImg").val() + "," + fileName);
            $("#spanErr").html("");
            $("#spanImgInfo").append("<div><img width='100' height='100' src='/UploadFile/" + fileName + "' /><br /><a class='del' href='javascript:void(0);' title='" + fileName + "'>删除</a></div>");
        }
        function ErrorUploadImg(errInfo) {
            $("#spanErr").html(errInfo);
        }
    </script>
</head>
<body>
    <form method="post" action="~/Home/Demo06Show" id="frm1" enctype="multipart/form-data">
        <iframe id="frameFile" name="frameFile" style="display: none;"></iframe>
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">员工新增</td>
                </tr>
                <tr>
                    <td width="200" align="right">所属部门：</td>
                    <td width="600" align="left">
                        <select name="DeptName" id="DeptName">
                            <option value="请选择">--请选择--</option>
                            <option value="总经办">总经办</option>
                            <option value="行政部">行政部</option>
                            <option value="市场部">市场部</option>
                            <option value="技术部">技术部</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">员工姓名：</td>
                    <td width="600" align="left"><input type="text" name="RealName" /></td>
                </tr>
                <tr>
                    <td width="200" align="right">头像：</td>
                    <td width="600" align="left">
                        <input type="file" name="fileImg" id="fileImg" />
                        <input id="btUpload" type="button" value="上传" />
                        <span id="spanErr"></span>
                        <br />
                        <span id="spanImgInfo"></span>
                        <input type="hidden" name="hdImg" id="hdImg" />
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">员工电话：</td>
                    <td width="600" align="left"><input type="text" name="Phone" /></td>
                </tr>
                <tr>
                    <td width="200" align="right">性别：</td>
                    <td width="600" align="left">
                        <input type="radio" name="Sex" id="boy" value="男" />男
                        <input type="radio" name="Sex" id="girl" value="女" />女
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">爱好：</td>
                    <td width="600" align="left">
                        <input type="checkbox" name="ckHobby" value="抽烟" />抽烟
                        <input type="checkbox" name="ckHobby" value="喝酒" />喝酒
                        <input type="checkbox" name="ckHobby" value="烫头发" />烫头发
                        <input type="checkbox" name="ckHobby" value="打游戏" />打游戏
                        <input type="hidden" name="Hobby" id="Hobby" value="" />
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input id="btAdd" type="submit" value="新增员工" />
                    </td>
                </tr>
            </table>
        </div>
    </form>
</body>
</html>
```

信息显示View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo06Show</title>
    <style type="text/css">
        #container div {
            height: 30px;
            line-height: 30px;
        }
    </style>
</head>
<body>
    <div id="container">
        @Html.Raw(ViewBag.Info)
    </div>
</body>
</html>
```

## 四、模型验证

资料（模型验证模型类）：

```
public class MemberMetadata
{
    //非空，长度在5-12位之间（占位符中第一个参数是字段名称（Compare中为比较的另一个字段的名称），后面的参数依次排列）
    //[Required(ErrorMessage = "用户名不能为空"),StringLength(12,MinimumLength =5,ErrorMessage ="用户名长度必须在5-12之间")]
    [Required(ErrorMessage = "用户名不能为空"), StringLength(12, MinimumLength = 5, ErrorMessage = "用户名长度必须在5-12之间")]
    public string Account { get; set; }  //用户名
    //非空，长度在5-12位之间
    [Required(ErrorMessage = "密码不能为空"), StringLength(12, MinimumLength = 5, ErrorMessage = "密码长度必须在5-12之间")]
    public string Pwd { get; set; } //密码
    //非空，字段值必须和Pwd值相同
    [Required(ErrorMessage = "密码确认不能为空"), System.ComponentModel.DataAnnotations.Compare("Pwd",ErrorMessage ="两次输入密码不一致") ]
    public string PwdConfirm { get; set; } //密码确认
    //非空，必须是日期格式
	[Required(ErrorMessage = "生日不能为空"), DataType(DataType.Date), RegularExpression(@"^((19\d{2})|(20\d{2}))-(0?[1-9]|1[0-2])-(0?[1-9]|[1-2]\d|3[0-1])$",ErrorMessage = "生日格式不正确")]
    public string Birth { get; set; } //生日
    //非空，正则判断邮箱格式
    [Required(ErrorMessage = "邮箱不能为空"), RegularExpression(@"^\w+@\w+.[a-zA-Z]{2,3}(.[a-zA-Z]{2,3})?$",ErrorMessage ="邮箱格式不正确")]
    public string Mail { get; set; } //邮箱
    //非空,范围在50-300之间
    [Required(ErrorMessage = "体重不能为空"),Range(50,300,ErrorMessage ="体重在50-300之间")]
    public int Weight { get; set; } //体重
    //非空,范围在50-300之间
    [Required(ErrorMessage = "身高不能为空"), Range(50, 300, ErrorMessage = "身高在50-300之间")]
    public int Height { get; set; } //身高

}
```

模型验证与EF结合的时候需要的数据表：

```
create table Member
(
	MemId int primary key identity(1,1),
	Account varchar(50) not null,
	Pwd varchar(50) not null,
	Birth varchar(50) not null,
	Mail varchar(50) not null,
	Weight int not null,
	Height int not null
)
```

### （1）基本模型验证

Action:

```
//验证用户输入合法性
public ActionResult Demo07()
{
	return View();
}
[HttpPost]
public ActionResult Demo07(MemberMetadata mem)
{
    if (ModelState.IsValid)
    {
        string str = "<div style='height:30px; line-height:30px;'>注册成功!注册信息如下:</div>";
        str += "<ul>";
        str += "<li>用户名:"+mem.Account+"</li>";
        str += "<li>密码:"+mem.Pwd+"</li>";
        str += "<li>生日:"+mem.Birth+"</li>";
        str += "<li>邮箱:"+mem.Mail+"</li>";
        str += "<li>体重:"+mem.Weight+"</li>";
        str += "<li>身高:"+mem.Height+"</li>";
        str += "</ul>";
        ViewBag.Info = str;
    }
    return View();
}
```

View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo07</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }

        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }

        .myTable td {
            height: 30px;
            line-height: 30px;
            padding: 6px;
        }
    </style>
</head>
<body>
    <form method="post" action="~/Home/Demo07">
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">会员注册</td>
                </tr>
                <tr>
                    <td width="200" align="right">用户名：</td>
                    <td width="600" align="left"><input type="text" name="Account" id="Account" />
                    @Html.ValidationMessage("Account")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">密码：</td>
                    <td width="600" align="left"><input type="password" name="Pwd" id="Pwd" />
                    @Html.ValidationMessage("Pwd")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">密码确认：</td>
                    <td width="600" align="left"><input type="password" name="PwdConfirm" id="PwdConfirm" />
                    @Html.ValidationMessage("PwdConfirm")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">生日：</td>
                    <td width="600" align="left"><input type="text" name="Birth" id="Birth" />
                    @Html.ValidationMessage("Birth")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">邮箱：</td>
                    <td width="600" align="left"><input type="text" name="Mail" id="Mail" />
                    @Html.ValidationMessage("Mail")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">体重：</td>
                    <td width="600" align="left"><input type="text" name="Weight" id="Weight" />
                    @Html.ValidationMessage("Weight")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">身高：</td>
                    <td width="600" align="left"><input type="text" name="Height" id="Height" />
                    @Html.ValidationMessage("Height")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input id="btReg" type="submit" value="会员注册" />
                    </td>
                </tr>
            </table>
        </div>
        <div style="height:30px; line-height:30px;">
            @Html.ValidationSummary()
            @(Html.Raw(ViewBag.Info))
        </div>
    </form>
</body>
</html>
```

### （2）自定义样式和保留状态

Action:

```
//给验证效果添加自定义样式
public ActionResult Demo08()
{
    return View();
}
[HttpPost]
public ActionResult Demo08(MemberMetadata mem)
{
    if (ModelState.IsValid)
    {
        string str = "<div style='height:30px; line-height:30px;'>注册成功!注册信息如下:</div>";
        str += "<ul>";
        str += "<li>用户名:" + mem.Account + "</li>";
        str += "<li>密码:" + mem.Pwd + "</li>";
        str += "<li>生日:" + mem.Birth + "</li>";
        str += "<li>邮箱:" + mem.Mail + "</li>";
        str += "<li>体重:" + mem.Weight + "</li>";
        str += "<li>身高:" + mem.Height + "</li>";
        str += "</ul>";
        ViewBag.Info = str;
    }
    return View();
}
```

View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo08</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }

        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }

            .myTable td {
                height: 30px;
                line-height: 30px;
                padding: 6px;
            }
        /*验证不通过的表单控件样式*/
        .input-validation-error {
            border: 1px solid #f00;
            background-color: #fee;
        }
        /*每个表单元素后面的提示内容样式*/
        .field-validation-error {
            color:red;
        }
        /*最下面的错误提示样式*/
        .validation-summary-errors {
            color:red;
        }
    </style>
</head>
<body>
    <form method="post" action="~/Home/Demo08">
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">会员注册</td>
                </tr>
                <tr>
                    <td width="200" align="right">用户名：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Account")
                        @Html.ValidationMessage("Account")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">密码：</td>
                    <td width="600" align="left">
                        @Html.Password("Pwd")
                        @Html.ValidationMessage("Pwd")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">密码确认：</td>
                    <td width="600" align="left">
                        @Html.Password("PwdConfirm")
                        @Html.ValidationMessage("PwdConfirm")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">生日：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Birth")
                        @Html.ValidationMessage("Birth")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">邮箱：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Mail")
                        @Html.ValidationMessage("Mail")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">体重：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Weight")
                        @Html.ValidationMessage("Weight")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">身高：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Height")
                        @Html.ValidationMessage("Height")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input id="btReg" type="submit" value="会员注册" />
                    </td>
                </tr>
            </table>
        </div>
        <div style="height:30px; line-height:30px;">
            @Html.ValidationSummary()
            @(Html.Raw(ViewBag.Info))
        </div>
    </form>
</body>
</html>
```

### （3）模型验证和EF结合

在EF框架生成的实体类中直接进行模型验证代码的编写，如果EF框架内容更新或者删除后重新生成EF框架内容，会导致模型代码的丢失。

针对以上问题，我们可以如下解决方案：

（1）编写一个分布类，没有任何内容。

（2）编写一个模型验证的类，进行模型验证。

（3）在分布类上使用  [MetadataType(typeof(验证类型))]  指定元数据注解（模型验证类）。

**具体案例如下：**

（1）利用资料提供的数据库脚本创建数据库。

（2）在VS开发环境中，添加EF框架内容。

（3）准备好模型验证类，在资料中已经准备好。

（4）在Models文件夹中创建MyEntity类，在其中编写分布类：

```
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Web;
using WebApplication4.Controllers;

namespace WebApplication4.Models
{
    [MetadataType(typeof(MemberMetaData))]
    public partial class Member
    {
        public string PwdConfirm { get; set; }
    }
}
```

（5）Action代码：

```
public ActionResult Demo09()
{
    return View();
}
[HttpPost]
public ActionResult Demo09(Member mem)
{
    if(ModelState.IsValid == true)
    {
        DBTESTEntities db = new DBTESTEntities();
        db.Member.Add(mem);
        db.SaveChanges();
    }
    return View();
}
```

（6）View:

```
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Demo09</title>
    <style type="text/css">
        div, table, tr, td {
            margin: 0px;
            padding: 0px;
        }

        .myTable {
            width: 800px;
            margin: 20px auto;
            border-collapse: collapse;
        }

            .myTable td {
                height: 30px;
                line-height: 30px;
                padding: 6px;
            }

        .field-validation-error, .validation-summary-errors {
            color: red;
        }

        .input-validation-error {
            border: solid 1px red;
            background-color: pink;
        }
    </style>
</head>
<body>
    <form method="post" action="Demo09">
        <div style="text-align:center;">
            <table width="800" class="myTable" border="1">
                <tr>
                    <td colspan="2" align="center" style="font-weight:bold;">会员注册</td>
                </tr>
                <tr>
                    <td width="200" align="right">用户名：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Account")
                        @Html.ValidationMessage("Account")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">密码：</td>
                    <td width="600" align="left">
                        @Html.Password("Pwd")
                        @Html.ValidationMessage("Pwd")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">密码确认：</td>
                    <td width="600" align="left">
                        @Html.Password("PwdConfirm")
                        @Html.ValidationMessage("PwdConfirm")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">生日：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Birth")
                        @Html.ValidationMessage("Birth")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">邮箱：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Mail")
                        @Html.ValidationMessage("Mail")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">体重：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Weight")
                        @Html.ValidationMessage("Weight")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right">身高：</td>
                    <td width="600" align="left">
                        @Html.TextBox("Height")
                        @Html.ValidationMessage("Height")
                    </td>
                </tr>
                <tr>
                    <td width="200" align="right"></td>
                    <td width="600" align="left">
                        <input id="btReg" type="submit" value="会员注册" />
                    </td>
                </tr>
            </table>
        </div>
        <div style="height:30px; line-height:30px;">
            @Html.ValidationSummary()
            @Html.Raw(ViewBag.Info)
        </div>
    </form>
</body>
</html>
```

代码中提供下拉框，单选框，多选框验证。



